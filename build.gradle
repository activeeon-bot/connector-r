apply plugin: 'java'

buildscript {
	repositories {
		if (project.hasProperty('useMavenLocal')) {
			println "Use mavel local repository"
			mavenLocal()
		}
		mavenCentral()
		maven { url 'http://repo.activeeon.com/content/repositories/snapshots/' }
		maven { url 'http://repo.activeeon.com/content/repositories/releases/' }
 		maven { url 'http://repo.activeeon.com/content/repositories/thirdparty/' }
		maven { url 'http://spoon.gforge.inria.fr/repositories/releases/' }		
	}
}

subprojects {
	apply plugin: 'base'

	group = 'org.ow2.proactive.r_connector'
	version = '0.9-SNAPSHOT'

	rootProject.buildscript.repositories.each {
        	repositories.add(it)
	}

	task propertyCheck() << {
		println "Check required environment variables."
		assert System.getenv()['JAVA_HOME'] != null : "Environment variable 'JAVA_HOME' is not set."
		assert System.getenv()["R_HOME"] != null : "Environment variable 'R_HOME' is not set."
		assert System.getenv()["R_LIBS"] != null : "Environment variable 'R_LIBS' is not set."
	}

	test {
		forkEvery = 100
	}

	test.dependsOn propertyCheck
}



project(':par-script') {
	apply plugin: 'java'

	dependencies {
		compile "org.apache.commons:commons-lang3:3.1"

		compile "org.objectweb.proactive:programming-extension-dataspaces:5.5.0-SNAPSHOT"
		compile "org.ow2.proactive:scheduler-api:3.5.0-SNAPSHOT"
		compile "org.ow2.proactive:scheduler-node:3.5.0-SNAPSHOT"
		compile "org.ow2.proactive:common-api:3.5.0-SNAPSHOT"
		compile "org.ow2.proactive:rm-node:3.5.0-SNAPSHOT"

		compile "org.rosuda:jriengine:0.5.x" 
		compile "org.rosuda:jri:0.5.x"
		compile "org.rosuda:jrs:28r"
		compile "org.rosuda:rengine:1.7.x"
		compile "org.rosuda:rserveengine:1.7.x"

		testCompile 'junit:junit:4.11'
	}
	
	test {
		forkEvery 1
	}
}

project(':par-connector') {
	def rExec
	def rSrc
	def env = [:]
	
	configurations {
		copyJars 
	}

	dependencies {
		 copyJars "org.ow2.proactive_grid_cloud_portal:rest-client:1.5.0-SNAPSHOT"
	}

	task pkg() << {
		// copy source
		copy {
			from file("${projectDir}/src/main/r")
			into file("${buildDir}/r-pkg-src")
		}
		// copy jars	
		copy {
			from configurations.copyJars
			into file("${buildDir}/r-pkg-src/inst/java")			
		}
		// check r package
		println "Check R add-on package."
		exec { 
			workingDir "${buildDir}"
			commandLine rExec, "CMD", "check", "--no-codoc", "--no-manual", "--no-multiarch", "PARConnector"
			environment env
		}
		// build r package
		println "Build R add-on package"
		exec {
			workingDir "${buildDir}"
			commandLine rExec, "CMD", "INSTALL", "--build", "--preclean", "--with-keep.source", "--no-multiarch", rSrc
			environment env
		}		
	}

	task setEnv() << {
		System.getenv().each() { k,v -> 
			env.put(k, v)
		}
		if (! System.properties["os.name"].toLowerCase().contains("mac")) {
			env.put('JAVA_HOME', env.get('JAVA_HOME') + File.separator + 'jre')
		}
		if (System.properties["os.name"].toLowerCase().contains("linux")) {
			def ldLib
			if (System.getProperty('os.arch').contains('64')) {
				ldLib = new File(env.get('JAVA_HOME'), 'lib/amd64/server')
			} else {
				ldLib = new File(env.get('JAVA_HOME'), 'lib/i386/client')
			}
			assert ldLib.exists() : "Cannot locate LD_LIBRARY_PATH: " + ldLib.getAbsolutePath()
			env.put('LD_LIBRARY_PATH', ldLib.getAbsolutePath())
		}
                
	}

	task setRExec() << {
		if (System.properties["os.name"].toLowerCase().contains("windows")) {
			def ARCH = System.getenv()["ProgramFiles(x86)"] != null ? "x64" : "i386"
			rExec = System.getenv()["R_HOME"] + File.separator +  "bin" + File.separator + ARCH + File.separator + "R.exe"
		} else {
			rExec = System.getenv()["R_HOME"] + File.separator +  "bin" + File.separator + "R"
		}
	}

	task setRSrc() << {
		rSrc = file("${buildDir}/r-pkg-src").getAbsolutePath()
	}

	pkg.dependsOn propertyCheck, setEnv, setRExec, setRSrc
}


